<style>
	#editTemplateLayoutTable > tbody > tr > td{
		vertical-align: top;
		padding: 0 1em 0 1em;
		width: 33.33%;
	};
	#editTemplateLayoutTable > tbody > tr > td:FIRST-CHILD {
		padding: 0 1em 0 0;
	};
	#editTemplateLayoutTable > tbody > tr > td:LAST-CHILD {
		padding: 0 0 0 1em;
	};
</style>

<form class="card" id="template-form">
	<div class="card-body">
		<input type="text" style="display: none;" id="templateId" name="id" data-value="id">
		<table style="width: 100%" id="editTemplateLayoutTable">
			<tr>
				<td>
					<div class="form-group">
						<label for="templateName">Name</label> 
						<input data-rule-required="true" data-rule-minlength="3" data-rule-maxlength="255" class="form-control" id="templateName" name="name" data-value="name" placeholder="Template Name">
					</div>
				<td>
					<div class="form-group">
						<label for="inactivityPeriod">Inactivity Period</label> 
						<input data-rule-required="true" data-rule-digits="true" data-rule-min="60" type="text" class="form-control" id="inactivityPeriod" name="inactivityPeriod" data-value="inactivityPeriod" placeholder="Inactivity Period (in seconds)">
					</div>
				</td>
				<td rowspan="2">
					<div class="form-group">
						<label for="templateProperties">Properties</label>
						<textarea data-rule-maxlength="255" placeholder="key=value" class="form-control" id="templateProperties" data-value="properties" name="properties" data-format="MapFormatter" data-format-target="value" rows="5"></textarea>
					</div>
				</td>
			</tr>
			<tr>
				<td>
					<div class="form-group">
						<label for="templateDescription">Description</label> 
						<input data-rule-maxlength="255" type="text" class="form-control" id="templateDescription" name="description" data-value="description" placeholder="Template Description">
					</div></td>
				</td>
				<td>
					<div class="form-group">
						<label for="templateTags">Tags</label> 
						<input type="text" class="form-control" id="templateTags" data-value="tags" data-role="tagsinput" name="tags">
					</div>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<h3>Metrics</h3>
					<table id="metrics-table" class="table table-striped table-bordered table-sm" style="width: 100%;">
						<thead>
							<tr>
								<th scope="col">Name</th>
								<th scope="col">Abbreviation</th>
								<th scope="col">Unit</th>
								<th scope="col">Data Type</th>
								<th scope="col">Description</th>
								<th scope="col">
									<button type="button" class="btn btn-primary btn-sm" formnovalidate="formnovalidate" id="newMetricBtn">
										<span class="fa fa-plus"></span> New Metric
									</button>
								</th>
							</tr>
						</thead>
					</table>
				</td>
			</tr>
		</table>

		<div class="button-bar">
			<a href="#" id="cancelButton" class="btn btn-secondary"> <i class="fa fa-trash"></i> Cancel
			</a>
			<button type="submit" href="#" id="saveButton" class="btn btn-primary">
				<i class="fa fa-save"></i> Save
			</button>
		</div>


	</div>
</form>



<script>
	render = (function($) {
		var template = null;
	    var metricsDataTable = null;
	   
	    var showMatricEditorModal = function(event, source, originalEvent, index) {
		    source.blur();
		    originalEvent.preventDefault();
		    metric = metricsDataTable.row(index).data();
		    showMetricEditView(metric);
	    };
	    var showMetricEditView = function(metric) {
	    	metric = metric ? metric : {dataType: "NUMBER"};
		    $("#modal-container").loadTemplate("pages/metrics/edit.html", metric, {
			    success : function() {
			    	$("#modal-container").modal();
			    	renderModal(metric, template.metrics, function(){
				    	if(!metric.id){
				    		template.metrics.push(metric);
				    	}
				    	metricsDataTable.clear().rows.add(template.metrics).draw();
				    });
			    }
		    });
	    };
	    var showMetricDeleteConfirmation = function(event, source, originalEvent, index) {
		    source.blur();
		    originalEvent.preventDefault();
		    row = metricsDataTable.row(index);
		    metric = row.data();
		    $.publish("show-confirmation-modal", [ {
			    message : "Are you sure you want to delete metric " + metric.name + " ?"
		    }, function() {
			    row.remove().draw();
			    $.modal.close();
		    } ]);
	    };
	    
	    $("#template-form").validate({
	    	errorPlacement: function(error, element) {
				$(element).closest("form").find( "label[for='"+element.attr( "id" )+"']").append(error);
			},
			errorElement: "span",
			messages:{
				inactivityPeriod:{
					min: "Value must be more than 60"
				}
			},
	        rules : {
		        name : {
		            remote : {
		                url : "/api/v1/templates",
		                data : {
		                    id : function() {
			                    return $("#templateId").val();
		                    },
		                    name : function() {
			                    return $("#templateName").val();
		                    }
		                }
		            }
		        },
		        properties: {
		        	propertiesMap : true
		        }
	        },
	        submitHandler : function() {
	        	alert("sending template data");
		        templateService.save(JSON.stringify(toModel()));
	        }
	    });
	    
	    var toModel = function(template){
			template = template ? template : {};	    	
	    	template.id = $("#templateId").val();
	    	template.name = $("#templateName").val();
		    template.description = $("#templateDescription").val();
		    template.tags = $("#templateTags").val().split(",");
		    template.inactivityPeriod = $("#inactivityPeriod").val();
		    template.properties = {};
		    template.metrics = [];
		    $("#templateProperties").val().split("\n").forEach(function(item) {
		        var pair = item.split("=");
		        template.properties[pair[0]] = pair[1];
	        });
	    	return template;
	    };
	    
	    var toView = function(template){
	    	if(template){
	    		$("#page-title").html(template.id || template.id > 0 ? "Edit Templates Details" : "New Template");
	    		$("#templateId").val(template.id);
		    	$("#templateName").val(template.name);
			    $("#templateDescription").val(template.description);
			    $("#templateTags").tagsinput({
			    	  trimValue: true,
			    	  maxChars: 255,
			    	  maxTags: 10,
			    	  confirmKeys: [13, 32, 44, 186, 188]
			    });
			    if(template.tags){
			    	template.tags.forEach(function(tag){
			    		$("#templateTags").tagsinput("add",tag);
			    	});
			    }
			    $("#inactivityPeriod").val(template.inactivityPeriod);
			    $("#templateProperties").val($.map(template.properties, function(val, key) {
					return key + "=" + val;
				}).join("\n"));
	    		showMetricsDataTable(template.metrics);
	    	}
	    };
	    
	    var showMetricsDataTable = function(metrics) {
		    metricsDataTable = $("#metrics-table").DataTable({
                rowId : "id",
                searching : false,
                ordering : false,
                paging : false,
                info : false,
                data : metrics,
                columnDefs : [ {
                    targets : -1,
                    className : "text-center"
                } ],
                columns : [
                   {data : "name"},
                   {data : "abbreviation"},
                   {data : "unit"},
                   {data : "dataType"},
                   {data : "description"},
                   {render : function(data, type, full, meta) {
                     return '<div class="btn-group" role="group">'
                             + '<button type="button" class="btn btn-warning btn-xs" onclick="$(\'#metrics-table\').trigger(\'edit-metric\', [this, event, ' + meta.row + ']);">'
                             + '<span class="fa fa-edit"></span> Edit' + '</button>'
                             + '<button type="button" class="btn btn-danger btn-xs" onclick="$(\'#metrics-table\').trigger(\'delete-metric\', [this, event, ' + meta.row + ']);">'
                             + '<span class="fa fa-trash"></span> Delete' + '</button>' + '</div>';
                    }
                   }]
            });
	    };
	   	
	    var bindEventHandlers = function(){
	    	$("#metrics-table").on("edit-metric", showMatricEditorModal);
	    	$("#metrics-table").on("delete-metric", showMetricDeleteConfirmation);
	    	$("#cancelButton").click(function(){
	    		window.history.back();
	    	});
	 	    $("#newMetricBtn").click(function() {
	 		    showMetricEditView(null);
	 	    });
	 	    $("template-form").submit(function(e){
	 	        e.preventDefault();
	 	    });
	    };
	    
	    var load = function(id){
	    	if(id && id > 0){
    		 	templateService.findOne(id, function(data, status){
    		 		template = data;
    		 		toView(template);
   				});
	    	}else{
	    		template = {metrics:[]};
	    		toView(template);
	    	}
	    };
	    
	    return function(id){
	    	load(id);
	    	bindEventHandlers();
	    };
    })(jQuery);
</script>